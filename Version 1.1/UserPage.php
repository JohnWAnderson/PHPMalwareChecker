<?php
require_once 'Functions.php';
require_once 'Data.php';
require_once 'secure.php';
session_start();
#set global variables to nothing to prevent script information
$Bytes = '';
$link = null;
$handle = '';
$added = '';
$MalName = '';
$type = '';
$name = '';
$welcome ='';
$bool = false;
$i = 1;
$approving = array();
if(isset($_SESSION['check']) && isset($_COOKIE['token'])  && isset($_SESSION['name']) && ($_SESSION['privilege'] === 'USER') && $_SESSION['check'] === hash('ripemd128', $_SERVER['REMOTE_ADDR'] . $_SERVER['HTTP_USER_AGENT'] . $_COOKIE['token']))
{
	session_regenerate_id();
	$name = $_SESSION['name'];
	$welcome = "Hello $name";
    echo <<<_END
        <html>
		<head><title>User Upload Page</title>
		<head>
		<title> form </title>	
		<script>
			function Validate(form) {
				fail = validateUsername(form.MalName.value)
				if (fail == "") return true
				else { alert(fail); return false }
			}
				
			function validateUsername(field){
				var regex = /^[0-9a-zA-Z]+$/;
				if(field== "") return "no MalName entered.\n"
				else if(field.length < 4) return "MalName Length must be at least 4.\n"
				else if(field.length >= 32) return "MalName Length must be less then 32.\n"
				else if(!field.match(regex)) return "Invalid characters used in MalName.\n"
				else return ""
			}
					
		</script>
		</head>
		<head>Admin Upload Page</head>
		<Br>
		$welcome
		<Br>
		<body>
		<input type="button" value="Home Page" onclick="location='HomePage.php'" />
		<Br>
`		<form action="UserPage.php" method="post" enctype="multipart/form-data" onsubmit = "return Validate(this)">
		<label for='MalName' >Malware Name:</label>
		<input type = "MalName" maxlength="32" name = "MalName" id = "MalName" required/>
		<Br>
        <input type="file" name="file"required/>
        <input type="submit" name = "submit" value="Submit File" /> 
		<Br>
        </form>
		<form action="UserPage.php" method="post" enctype="multipart/form-data">
		<input type="submit" name = "Logout" value="Logout" /> 
		</form>
		<Br>
_END;
	$link = mysqli_connect($hn, $un, $pw, $db);
	if (mysqli_connect_errno()) die(mysqli_connect_error());
	$result = UserApprove($link, $name);
	if($result->num_rows !== 0){
		echo '<form action="UserPage.php" method="post" enctype="multipart/form-data">';
		while($row = $result->fetch_array(MYSQLI_ASSOC)){
			$approving += array($i => $row['UserMalID']);
			if($row['approved'] == true) $bool = 'Approved';
			else $bool = 'Declined';
			echo  <<<_Former
			<fieldset id = "group$i">
				Your Upload $row[name] has been $bool
			</fieldset>
_Former;
		$i = $i +1;
		}
		$result->close();
		echo '<input type="submit" name = "OK" value="OK" /> </form>';
	}
	
	if(isset($_POST['OK']))
	{	
		foreach($approving as $key => $ID){
			userSeeing($link, $ID);
		}
		header("Refresh:0");
	}
	
    if($_FILES)
    {
		$location = $_FILES['file']['tmp_name'];
		if(($size = filesize($location)) >= 8388608 ){
			echo "File To Big";
			exit;
		}
		$MalName = checkMalwareName(mysql_entities_fix_string($link ,($_POST['MalName'])));
		$type = $_FILES['file']['type'];
		$String = file_get_contents($location);
		$Bytes = hashBytes(getBytes($location, $type, 20));
		$done = MalCheckDup($link, $MalName, $Bytes);
		if($done[0] === True || $done[1] === True)
			exit;
		if(userMal($link, $MalName, $String, $name, $type))
			echo "$MalName was added to be viewed by admin";
		else
			echo "$MalName was denined";
    }
	mysqli_close($link);
	if(isset($_POST['Logout']))
	{
		destroy_session_and_data();
		header('Location: LoginAdmin.php');
	}
	
}
else{
	echo  <<<Perm
	<html><body> No Permission <Br>
	<input type="button" value="Home Page" onclick="location='HomePage.php'" />
Perm;
}

	echo"</body></html>"
?>