<?php
require_once 'Functions.php';
require_once 'Data.php';
require_once 'secure.php';
session_start();
#set global variables to nothing to prevent script information
$Bytes = '';
$link = null;
$handle = '';
$added = '';
$MalName = '';
$type = '';
$name = '';
$welcome ='';

if(isset($_SESSION['check']) && isset($_COOKIE['token'])  && isset($_SESSION['name']) && ($_SESSION['privilege'] === 'ADMIN') && $_SESSION['check'] === hash('ripemd128', $_SERVER['REMOTE_ADDR'] . $_SERVER['HTTP_USER_AGENT'] . $_COOKIE['token']))
{
	session_regenerate_id();
	$name = $_SESSION['name'];
	$welcome = "Hello admin: $name";
    echo <<<_END
        <html>
		
		<head><title>Admin Upload Page</title>
		<head>
		<title> form </title>	
		<script>
			function Validate(form) {
				fail = validateUsername(form.MalName.value)
				if (fail == "") return true
				else { alert(fail); return false }
			}
				
			function validateUsername(field){
				var regex = /^[0-9a-zA-Z]+$/;
				if(field== "") return "no MalName entered.\n"
				else if(field.length < 4) return "MalName Length must be at least 4.\n"
				else if(field.length > 32) return "MalName Length must be less then 32.\n"
				else if(!field.match(regex)) return "Invalid characters used in MalName.\n"
				else return ""
			}
					
		</script>
		</head>
		<head>Admin Upload Page</head>
		<Br>
		$welcome
		<Br>
		<body>
		<input type="button" value="Home Page" onclick="location='HomePage.php'" />
		<Br>
		<input type="button" value="Admin approve" onclick="location='AdminApprove.php'" />
		<Br>
`		<form action="AdminPage.php" method="post" enctype="multipart/form-data" onsubmit = "return Validate(this)">
		<label for='MalName' >Malware Name:</label>
		<input type = "MalName" maxlength="32" name = "MalName" id = "MalName" required/>
		<Br>
        <input type="file" name="file"required/>
        <input type="submit" name = "submit" value="Submit File" /> 
		<Br>
        </form>
		<form action="AdminPage.php" method="post" enctype="multipart/form-data">
		<input type="submit" name = "Logout" value="Logout" /> 
		</form>
		<Br>
_END;


	$link = mysqli_connect($hn, $un, $pw, $db);
	if (mysqli_connect_errno()) die(mysqli_connect_error());
    if($_FILES)
    {
		$MalName = checkMalwareName(mysql_entities_fix_string($link ,($_POST['MalName'])));
		$handle = $_FILES['file']['tmp_name'];
		$type = $_FILES['file']['type'];
		$Bytes = getadminBytes($handle, $type, 20);
		$Bytes = hashBytes($Bytes);
		$done = MalCheckDup($link, $MalName, $Bytes);
		if($done[0] === True || $done[1] === True)
			exit;
		$added = malNameInsert($link, $MalName, $Bytes, $name);
		if($added){
		echo "Added Malware: <Br>$added";
		}
    }
	mysqli_close($link);
	
	if(isset($_POST['Logout']))
	{
		destroy_session_and_data();
		header('Location: LoginAdmin.php');
	}
}
else{
	echo  <<<Perm
	<html><body> No Permission <Br>
	<input type="button" value="Home Page" onclick="location='HomePage.php'" />
Perm;
}

	echo"</body></html>"
?>