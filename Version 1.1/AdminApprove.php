<?php
require_once 'Functions.php';
require_once 'Data.php';
require_once 'secure.php';
session_start();
$approving = array();
$name = '';
$welcome ='';
$i =1;
$Select = '';
$result = '';
$row= '';
$message = '';


if(isset($_SESSION['check']) && isset($_COOKIE['token'])  && isset($_SESSION['name']) && ($_SESSION['privilege'] === 'ADMIN') && $_SESSION['check'] === hash('ripemd128', $_SERVER['REMOTE_ADDR'] . $_SERVER['HTTP_USER_AGENT'] . $_COOKIE['token']))
{
	$name = $_SESSION['name'];
	$welcome = "Hello admin: $name";
	
	echo <<<_END
        <html>
		<head><title>Admin Approve</title>
		<head>
		</head>
		<head>Admin Upload Page</head>
		<Br>
		$welcome
		<Br>
		<body>
		<input type="button" value="Home Page" onclick="location='HomePage.php'" />
		<Br>
		<input type="button" value="Admin Page" onclick="location='AdminPage.php'" />
		<Br>
		</form>
		<form action="AdminApprove.php" method="post" enctype="multipart/form-data">
		<input type="submit" name = "Logout" value="Logout" /> 
		</form>
		<Br>
_END;
	
	

	$link = mysqli_connect($hn, $un, $pw, $db);
	if (mysqli_connect_errno()) die(mysqli_connect_error());
	
	
	$result = AdminApprove($link);
	if($result->num_rows !== 0){
		echo '<form action="AdminApprove.php" method="post" enctype="multipart/form-data">';
		while($row = $result->fetch_array(MYSQLI_ASSOC)){
			#print_r($row);
			$done = MalCheckDup($link, $row['name'], hashBytes(getBytesString($row['Sequence'], $row['type'])));
			if($done[1] === True){
				AdminApproving($link, $row['UserMalID'], 'False', $row['user'], 'nope');
			}
			if($done[0] === True)
				$message = '(Warning: needs a new name)';
			else
				$message = '';
			$approving += array($i => array($row['UserMalID'], $row['user'], $row['name']));
			echo  <<<_Former
			<fieldset id = "group$i">
				User $row[user], MalName $row[name] $message,
				Submitted 
				Approve:<input type="radio" value="True" name = "group$i" required/>
				Deny:<input type="radio" value="False" name = "group$i" required/>
				View Later:<input type="radio" value="" name = "group$i" required/>
				<input type = "text" maxlength="32" name = "MalName$i" id = "MalName">
			</fieldset>
			
_Former;
		$i = $i +1;
		}
		$result->close();
		echo '<input type="submit" name = "Select" value="Select" /> </form>';
	}
	
	if(isset($_POST['Select']))
	{	
		foreach($approving as $key => $ID){
			$Select = $_POST["group$key"];
			$name = $_POST["MalName$key"];
			if($Select !== ''){
				if($name == null)
					AdminApproving($link, $ID[0], $Select, $ID[1], $ID[2]);
				else
					AdminApproving($link, $ID[0], $Select, $ID[1], $name);
			}
		}
		header("Refresh:0");
	}
	
	if(isset($_POST['Logout']))
	{
		destroy_session_and_data();
		header('Location: LoginAdmin.php');
	}
}
else{
	echo  <<<Perm
	<html><body> No Permission <Br>
	<input type="button" value="Home Page" onclick="location='HomePage.php'" />
Perm;
}

	echo"</body></html>";
?>
