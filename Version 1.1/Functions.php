<?php
require_once 'secure.php';
	function mysql_entities_fix_string($link, $String)
	{
		if(LS_Check($link, $String))
			return htmlentities(mb_convert_encoding(mysql_fix_string($link, $String), 'UTF-8', 'ASCII'), ENT_SUBSTITUTE, "UTF-8");
		return "";
	}
	
	function mysql_fix_string($link, $String)
	{
		if(LS_Check($link, $String)){
			$String = stripslashes($String);
			return mysqli_real_escape_string($link, $String);
		}
		return "";
	}
	
	
	function login($link, $username, $password)
	{
		if(LUP_Check($link, $username, $password)){
			$sql = "select * from Users where UserName = '$username';";
			$result = sqlQuery($link,$sql);
			if (!$result)
				die($link->error);
			elseif($result->num_rows){
				$row = $result->fetch_array(MYSQLI_NUM);
				$result->close();
				$salts = getSalts($row);
				$s = $salts[0];
				$s2 = $salts[1];
				$token = hasher($password, $s, $s2);
				if ($token === $row[3]){ 
					$n = $row[2];
					$p = $row[6];
					startSession($n, $p);
					return True;
					}
				else die("Invalid username/password");
			}
			else
				die("Invalid username/password");
		}
		return False;
	}
	
	function getSalts($row){
		$salt = null;
		if($row && count($row) === 7){
			$salt[0] = $row[4];
			$salt[1] = $row[5];
		}
		return $salt;
	}

	function setCookies($username, $password){

		if(is_string($username) && is_string($password))
		{
			setcookie('user_cookie', $username, time() + 10, '/');
			setcookie('pass_cookie', $password, time() + 10, '/');
		}
	}
	
	function LLTA_Check($location, $type, $amount){
		return (CheckAmount($amount) && is_string($type) && file_exists($location));
	}
	
	function LTA_Check($location, $type, $amount){
		return (CheckAmount($amount) && is_string($type) && file_exists($location));
	}
	
	function getadminBytes($location, $type, $amount){
		if(LLTA_Check($location, $type, $amount)){
			$amount = getnewAmount($location, $type, $amount);
			return getBytes($location, $type, $amount);
		}
	}
	
	function getnewAmount($location, $type, $amount){
		if(LTA_Check($location, $type, $amount)){
			if(is_executable($location) !== false)
			{
				return $amount + 120;
			}
			elseif(isset($type) && $type === 'application/pdf')
			{
				return $amount + 10;
			}
			else{
				return $amount;
			}
		}
	}
	
	function getBytes($location, $type, $amount){
		if(LLTA_Check($location, $type, $amount)){
			if($type === 'text/plain')
			{
				return SeekReader($location, $amount, 0);
			}
			elseif($type === 'application/x-msdownload')
			{
				return SeekReader($location, $amount, 120);
			}
			else{
				#echo "<Br> file type not used Plain Text, executable, and pdfs. Information Might Be off<Br>";
				return SeekReader($location, $amount, 10);
			}
		}
		return "";
	}
	
	function getBytesString($String, $type){
		if(is_string($String) && is_string($type)){
			if($type === 'text/plain')
				{
					return substr ($String, 20, 0);
				}
				elseif($type === 'application/x-msdownload')
				{
					return substr ($String, 20, 120);
				}
				else{
					#echo "<Br> file type not used Plain Text, executable, and pdfs. Information Might Be off<Br>";
					return substr ($String, 20, 10);
				}
		}
		return "";
	}
	
	function hashBytes($string){
		if(is_string($string) && strlen($string) <= 20){
			return hash('ripemd128', "$string");
		}
	}
	
	#function BlobRead()
	
	function SeekReader($location, $amount, $header){
		$String = '';
		if(LLAH_Check($location, $amount, $header)){
			$handle = fopen($location,"rb");
			fseek($handle, $header);
			$String = fread($handle, ($amount - $header));
			fclose($handle);
		}
		return $String;	
	}
	
	
	function cleanslash($String){
		if(is_string($String))
			return str_replace('\\', '.-', $String);
	}
	
	function sqlQuery($link, $sql)
	{
		if(LS_Check($link, $sql)){
			return mysqli_query($link,$sql);
		}
	}
	
	function sqlStmt($link, $sql){
		if(LS_Check($link, $sql)){
			$stmt = mysqli_prepare($link,$sql);
			if(!$stmt->execute()){
				echo "Error: " . mysqli_Error($link);
				return false;
			}
			mysqli_stmt_close($stmt);
			return true;
		}
		return false;
	}
	
	function hasher($pass, $salt1, $salt2){
		if(is_string($pass) && is_string($salt1) && is_string($salt2)){
			return hash('ripemd128', "$salt1$pass$salt2");
		}
		return '';
	}
	
	function Salter(){
		$chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789`~!@#$%^&*()-=_+';
		$l = strlen($chars) - 1;
		$str = '';
		$size = rand (5, 10);
		for ($i = 0; $i < $size; ++$i) {
			$str .= $chars[rand(0, $l)];
		}
		return $str;
	}
	
	function malNameInsert($link, $MalName, $Bytes, $admin){
		if(mal_Check($link, $MalName, $Bytes, $admin)){
			$sql = "insert into malware(name, Sequence, admin) VALUES('$MalName', '$Bytes', '$admin');";
			$added = sqlStmt($link,$sql);
			if($added)
				return "$MalName: $Bytes";
		}
		return "";
	}
	
	function userMal($link, $MalName, $String, $name, $type){
		if(mal_Check($link, $MalName, $String, $name)){
			$stmt = $link->prepare("insert into usermalware(name, Sequence, user, type) values(?,?,?,?)");
			$stmt->bind_param('sbss', $MalName, $String, $name, $type);
			$stmt->send_long_data(1, $String);
			if(!$stmt->execute()){
				return False;
				mysqli_stmt_close($stmt);
			}
			else{
				return True;
				mysqli_stmt_close($stmt);
			}
			
		}
		return False;
	}
	
	function MalCheckDup($link, $MalName, $Bytes){
		$checker = array(False,False);
		if($link && is_string($MalName) && is_string($Bytes)){
			$result = getAllMalware($link);
			foreach($result as $row){
				if($row['Sequence'] === $Bytes){
					#echo "Malware already exits<Br>";
					$checker[1] = True;
				}
				if($row['Name'] === $MalName){
					#echo "Malware name already exits<Br>";
					$checker[0] = True;
				}
			}
		}
		return $checker;
	}
	
	function UserCheckDup($link, $username){
		if(is_string($username) && $link){
			$result = getAllUsers($link);
			foreach($result as $row){
				if($row['username'] === $username){
					echo "Username is already in use";
					exit;
				}
			}
		}
	}
	
	function AdminApprove($link){
		if($link){
		$sql = "SELECT * FROM usermalware where approved is NULL";
		return sqlQuery($link, $sql);
		}
	}
	
	function getAllUsers($link){
		if($link){
		$sql = "SELECT * FROM users";
		return sqlQuery($link, $sql);
		}
	}
	
	
	function NewUserApprove($link){
		if($link){
			$sql = "SELECT * FROM usermalware";
			return sqlQuery($link, $sql);
		}
	}
	
	function userSeeing($link, $ID){
		if(is_numeric($ID) && $link){
			$sql = "Delete FROM usermalware where UserMalID = $ID";
			sqlStmt($link, $sql);
		}
	}
	
	function UserApprove($link, $user){
		if(is_string($user) && $link){
			$sql = "SELECT name, approved, UserMalID FROM usermalware where approved is not NULL and user = '$user'";
			return sqlQuery($link, $sql);
		}
	}
	
	function AdminApproving($link, $ID, $Select, $admin, $name){
		if(is_numeric($ID) && is_string($Select) && $link){
			$sql = "Update usermalware set approved = $Select where UserMalID = $ID";
			sqlStmt($link, $sql);
			if($Select === 'True'){
				$sql = "SELECT * FROM usermalware WHERE UserMalID = $ID";
				$result = sqlQuery($link, $sql);
				$row = $result->fetch_array(MYSQLI_ASSOC);
				$result ->close();
				$row['Sequence'];
				$Bytes = hashBytes(getBytesString($row['Sequence'], $row['type']));
				
				malNameInsert($link, $name, $Bytes, $admin);
			}
		}
	}
	
	function getAllMalware($link){
		if($link){
			$sql = "select Name, Sequence from malware;";
			return sqlQuery($link,$sql);
		}
		return false;
	}
	
	function checkMalwareName($String){
		$regex = '/^[A-Za-z0-9]+$/';
		if(is_string($String) && strlen($String) > 3){
			if(strlen($String) < 33){
				if(preg_match($regex, $String))
					return $String;
				else{
					echo "Invalid characters used in MalName";
					exit;
					return "";
				}
			}
			else{
				echo "MalName Length must be 32 or less";
				exit;
				return "";
			}
		}
		else{
			echo "MalName Length must be at least 4";
			exit;
			return "";
		}	
	}
	
	
	function CheckUser($String){
		$regex = '/^[A-Za-z0-9_-]+$/';
		if(is_string($String) && strlen($String) >= 4){
			if(preg_match($regex, $String))
				return $String;
			else{
				echo "Invalid username <Br>";
				exit;
				return;
			}
		}
		else{
			echo "username not long enough";
			exit;
			return;
		}	
	}

	function CheckPass($String){
		$regex = '/^[A-Za-z0-9!@#$%^*()_+-=]+$/';
		if(is_string($String) && strlen($String) >= 6){
			if(preg_match($regex, $String))
				return $String;
			else{
				echo "Invalid password <Br>";
				exit;
				return;
			}
		}
		else{
			echo "Password not long enough";
			exit;
			return;
		}
	}

	function checkEmail($String){
		if(is_string($String) && filter_var($String, FILTER_VALIDATE_EMAIL)){
			return $String;
		}
		else{
			echo "Invalid email";
			exit;
			return;		
		}
	}
	
	function AddNewUser($link, $username, $email, $password){
		if($link &&  CheckUser($username) && CheckPass($password) && checkEmail($email)){
			$salt1 = Salter();
			$salt2 = Salter();
			$token = hasher($password, $salt1, $salt2);
			add_Users($link, $email, $username, $token, $salt1, $salt2, 'USER');
		}
	}
	
	function add_Users($connection, $em, $un, $pw, $s1, $s2, $p){
		if(CheckAddUser($connection, $em, $un, $pw, $s1, $s2, $p)){
			$query = "INSERT INTO Users(email, username, password, salt1, salt2, privilege) VALUES('$em', '$un', '$pw', '$s1', '$s2', '$p')";
			$result = $connection->query($query);
			if (!$result) die($connection->error);
		}
	}
	
	function CheckAddUser($connection, $em, $un, $pw, $s1, $s2, $p){
		return ($connection && CheckUser($un) && CheckPass($pw) && checkEmail($em) && hashcheck($s1) && hashcheck($s2) && ($p === 'USER' || $p === 'ADMIN'));		
	}
	
	function hashcheck($hash){
		return (is_string($hash) && strlen($hash)>= 5 && strlen($hash) <= 10);
	}
	
	function CheckAmount($amount){
		return (is_integer($amount) && $amount >= 0);
	}
	
	function LLA_Check($link ,$location, $amount){
		return (CheckAmount($amount)&& file_exists($location) && $link);
	}
	
	function LLAH_Check($location, $amount, $header){
		return (CheckAmount($amount)&& file_exists($location) && CheckAmount($header));
	}
	function LS_Check($link, $String){
		return (is_string($String) && $link);
	}
	
	function LUP_Check($link, $username, $password){
		return (is_string($username) && is_string($password) && $link);
	}
	
	function mal_Check($link, $String1, $String2, $String3){
		return ($link && is_string($String1) && is_string($String2) && is_string($String3));
	}
	
	function StringBool($bool){
		return ($bool === "False" or $bool === "True");
	}

	
	
	
	

?>